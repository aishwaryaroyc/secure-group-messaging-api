openapi: 3.0.3
info:
  title: Learning Yogi Secure Group Messaging API
  version: 1.0.0
servers:
  - url: http://localhost:4000
  - url: https://secure-group-messaging-api.onrender.com/
tags:
  - name: Auth
  - name: Groups
  - name: Messages
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
      required: [error]
    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: Validation failed
        details:
          type: array
          items:
            type: object
            properties:
              field: { type: string, example: password }
              message: { type: string, example: Password must be at least 8 characters }
    AuthToken:
      type: object
      properties:
        token:
          type: string
      required: [token]
    Group:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        type: { type: string, enum: [open, private] }
        owner: { type: string }
        members:
          type: array
          items: { type: string }
        bannedUsers:
          type: array
          items: { type: string }
        maxMembers:
          type: integer
          minimum: 0
          description: "0 = unlimited; otherwise must be at least 2 members"
      required: [ _id, name, type, owner, members, maxMembers ]
    JoinRequest:
      type: object
      properties:
        _id: { type: string }
        group: { type: string }
        user:
          oneOf:
            - type: string
            - type: object
              properties:
                _id: { type: string }
                email: { type: string, format: email }
        status: { type: string, enum: [pending, approved, declined] }
        createdAt: { type: string, format: date-time }
      required: [ _id, group, user, status ]
    InviteCreateResponse:
      type: object
      properties:
        message: { type: string, example: Invite created }
        token: { type: string, description: "Shown once to owner" }
        expiresAt: { type: string, format: date-time }
        maxUses: { type: integer }
      required: [ message, token, expiresAt, maxUses ]
    MessageOut:
      type: object
      properties:
        id: { type: string }
        sender:
          type: object
          properties:
            _id: { type: string }
            email: { type: string, format: email }
          required: [_id]
        createdAt: { type: string, format: date-time }
        text: { type: string }
      required: [ id, sender, createdAt, text ]

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
              required: [email, password]
      responses:
        "201":
          description: Registered
        "400":
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        "409":
          description: Email already registered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and get JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string }
              required: [email, password]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthToken' }
        "400":
          description: Invalid email or password (validation)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups:
    post:
      tags: [Groups]
      summary: Create a group
      description: "Owner becomes the first member. For maxMembers: 0 = unlimited; otherwise must be ≥ 2."
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                type: { type: string, enum: [open, private] }
                maxMembers:
                  type: integer
                  minimum: 0
                  description: "0 = unlimited; otherwise must be ≥ 2"
                initialMemberIds:
                  type: array
                  items: { type: string }
                  description: "Optional list of user IDs to add immediately; owner is auto-added."
              required: [name, type]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Group' }
        "400":
          description: Validation failed (e.g., maxMembers rule)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/public:
    get:
      tags: [Groups]
      summary: List public (open) groups
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: OK
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/mine:
    get:
      tags: [Groups]
      summary: List groups I belong to
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: OK
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/invites:
    post:
      tags: [Groups]
      summary: Create invite (owner only)
      description: "Returns a single-use or limited-use token; the raw token is shown once."
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                maxUses: { type: integer, minimum: 1, default: 1 }
                expiresInMinutes: { type: integer, minimum: 1, default: 60 }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/InviteCreateResponse' }
        "400":
          description: Invalid groupId or invalid invite params
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner can create invites
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/join-with-invite:
    post:
      tags: [Groups]
      summary: Join a group using invite token
      description: "Banned users cannot bypass approval with an invite."
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        "200":
          description: Joined via invite
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: Joined via invite }
                  groupId: { type: string }
        "400":
          description: Invalid/expired/exhausted invite or group full
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Banned user must request approval
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/join-open:
    post:
      tags: [Groups]
      summary: Join open group immediately
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      responses:
        "200":
          description: Joined
        "400":
          description: Invalid groupId or group full
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Banned / not allowed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found or not open
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/request-join:
    post:
      tags: [Groups]
      summary: Request to join private group
      description: "If already a member, returns a friendly message. Enforces 48h cooldown for re-joining private groups."
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      responses:
        "200":
          description: Request submitted or already pending
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  requestId: { type: string }
        "400":
          description: Invalid groupId or cooldown active
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Banned — a pending request is (re)submitted for owner approval
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found or not private
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/requests:
    get:
      tags: [Groups]
      summary: List pending join requests (owner only)
      description: "Returns **pending** requests only, newest first. Owner-only."
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/JoinRequest' }
        "400":
          description: Invalid groupId
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/requests/{requestId}/decision:
    post:
      tags: [Groups]
      summary: Approve or decline a join request (owner only)
      description: "Approving removes prior ban (if any) and adds user to members."
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: requestId
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                decision: { type: string, enum: [approve, decline] }
              required: [decision]
      responses:
        "200":
          description: Decision recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  status: { type: string, enum: [approved, declined] }
        "400":
          description: Invalid requestId / decision or group full
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Request or group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "409":
          description: Request already resolved
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/leave:
    post:
      tags: [Groups]
      summary: Leave a group (owner must transfer first)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      responses:
        "200":
          description: Left group
        "400":
          description: Invalid groupId, not a member, or owner must transfer first
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/banish:
    post:
      tags: [Groups]
      summary: Owner banishes a member
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string }
              required: [userId]
      responses:
        "200":
          description: User banished (idempotent if already banned)
        "400":
          description: Invalid groupId/userId or user is not a current member
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner / owner cannot banish self
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}/transfer:
    post:
      tags: [Groups]
      summary: Transfer ownership
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newOwnerId: { type: string }
              required: [newOwnerId]
      responses:
        "200":
          description: Ownership transferred
        "400":
          description: Invalid groupId/newOwnerId or new owner not a member
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /groups/{groupId}:
    delete:
      tags: [Groups]
      summary: Delete group (only owner & sole member)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      responses:
        "200":
          description: Deleted
        "400":
          description: Invalid groupId or multiple members still present
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Only owner
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /messages/{groupId}:
    post:
      tags: [Messages]
      summary: Send encrypted message
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text: { type: string }
              required: [text]
      responses:
        "201":
          description: Sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string }
                  createdAt: { type: string, format: date-time }
        "400":
          description: Validation failed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Not a member / Join group first
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    get:
      tags: [Messages]
      summary: List messages (decrypted on read)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
        - in: query
          name: since
          schema: { type: string, format: date-time }
          description: "Only messages created after this timestamp"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/MessageOut' }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Not a member / Join group first
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /messages/{groupId}/poll:
    get:
      tags: [Messages]
      summary: Simulated realtime polling
      description: "Returns count of new messages since timestamp."
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: groupId
          schema: { type: string }
          required: true
        - in: query
          name: since
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  newMessages: { type: integer }
                  lastChecked: { type: string, format: date-time }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "403":
          description: Not a member / Join group first
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        "404":
          description: Group not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
